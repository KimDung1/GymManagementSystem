<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê·∫∑t l·ªãch & L·ªõp t·∫≠p</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    
    <div id="modal-dat-lich" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>üìÖ ƒê·∫∑t L·ªãch T·∫≠p cho L·ªõp: <span id="ten-lop-dat-lich"></span></h3>
            <p>HLV: <span id="hlv-lop-dat-lich"></span> | Gi·ªù: <span id="gio-lop-dat-lich"></span></p>
            <form id="form-dat-lich">
                <input type="hidden" id="id-lop-dat" required> 
                
                <div class="form-group">
                    <label for="id-hoc-vien">ID H·ªçc vi√™n (Test: 1 ho·∫∑c 2)</label>
                    <input type="number" id="id-hoc-vien" value="1" required min="1">
                </div>
                <div class="form-group">
                    <label for="ngay-hoc">Ng√†y H·ªçc</label>
                    <input type="date" id="ngay-hoc" required> 
                </div>
                
                <button type="submit" class="btn-primary">X√°c nh·∫≠n ƒê·∫∑t l·ªãch</button>
            </form>
            <p class="warning-text">L∆∞u √Ω: C·∫ßn nh·∫≠p ƒë√∫ng ID H·ªçc vi√™n ƒë√£ c√≥ trong Database.</p>
        </div>
    </div>

    <div id="modal-them-lop" class="modal">
        <div class="modal-content">
            <span class="close-btn-lop">&times;</span>
            <h3>‚ûï Th√™m L·ªõp H·ªçc M·ªõi</h3>
            <form id="form-them-lop">
                <div class="form-group">
                    <label for="ten-lop">T√™n L·ªõp (V√≠ d·ª•: Yoga CƒÉn B·∫£n)</label>
                    <input type="text" id="ten-lop" required>
                </div>
                <div class="form-group">
                    <label for="lich-tap">L·ªãch T·∫≠p (V√≠ d·ª•: Th·ª© 2-4-6)</label>
                    <input type="text" id="lich-tap" required>
                </div>
                <div class="form-group">
                    <label for="so-luong-toi-da">S·ªë L∆∞·ª£ng T·ªëi ƒêa</label>
                    <input type="number" id="so-luong-toi-da" required min="1">
                </div>
                <div class="form-group">
                    <label for="gio-bat-dau">Gi·ªù B·∫Øt ƒê·∫ßu</label>
                    <input type="time" id="gio-bat-dau" required>
                </div>
                <div class="form-group">
                    <label for="gio-ket-thuc">Gi·ªù K·∫øt Th√∫c</label>
                    <input type="time" id="gio-ket-thuc" required>
                </div>
                <div class="form-group">
                    <label for="id-hlv-moi">ID Hu·∫•n Luy·ªán Vi√™n (T√πy ch·ªçn)</label>
                    <input type="number" id="id-hlv-moi" min="1" placeholder="Nh·∫≠p ID HLV (V√≠ d·ª•: 1)">
                </div>
                
                <button type="submit" class="btn-primary">L∆∞u L·ªõp H·ªçc</button>
            </form>
            <p class="warning-text">L∆∞u √Ω: ID HLV ph·∫£i t·ªìn t·∫°i trong b·∫£ng huan_luyen_vien.</p>
        </div>
    </div>

    <div class="header">
        <div>
            <h2>Qu·∫£n l√Ω ƒê·∫∑t l·ªãch & L·ªõp t·∫≠p</h2>
            <p>Giao di·ªán qu·∫£n l√Ω l·ªãch h·ªçc v√† l·ªõp t·∫≠p</p>
        </div>
        <div>
            <button class="btn-primary" id="btn-mo-modal-them-lop">‚ûï Th√™m L·ªõp M·ªõi</button>
            <button class="btn-primary" id="btn-refresh">üîÑ L√†m m·ªõi D·ªØ li·ªáu</button> 
        </div>
    </div>
    
    <div class="container">
        <div class="left-panel">
            
            <div class="tabs-control">
                <input type="radio" id="tab-lop-tap" name="tabs" checked>
                <label for="tab-lop-tap" class="tab">L·ªõp ƒëang m·ªü</label>

                <input type="radio" id="tab-danh-sach" name="tabs">
                <label for="tab-danh-sach" class="tab">Danh s√°ch L·ªãch ƒë√£ ƒë·∫∑t</label>

                <div class="tab-content-container">
                    
                    <div id="content-lop-tap" class="tab-content">
                        <div class="card">
                            <h3>üèãÔ∏è Danh s√°ch L·ªõp T·∫≠p</h3>
                            <div id="lop-tap-list">
                                <p class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu l·ªõp t·∫≠p...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="content-danh-sach" class="tab-content">
                       <div class="card">
                            <div class="header-actions">
                                <h3>üìö Danh s√°ch L·ªãch ƒë√£ ƒë·∫∑t</h3>
                                <div>
                                    <button id="btn-xoa-toan-bo-lich" class="btn-xoa-toan-bo-lich">
                                        X√≥a To√†n B·ªô L·ªãch üßπ
                                    </button>
                                    <button id="btn-xoa-muc-da-chon" class="btn-xoa-toan-bo-lich" disabled>
                                        üóëÔ∏è X√≥a M·ª•c ƒê√£ Ch·ªçn
                                    </button>
                                </div>
                            </div>
                            
                            <table class="lich-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20px;"></th> <th>H·ªçc vi√™n</th>
                                        <th>L·ªõp t·∫≠p</th>
                                        <th>Ng√†y h·ªçc</th>
                                        <th>Th·ªùi gian</th>
                                        <th>Tr·∫°ng th√°i</th>
                                    </tr>
                                </thead>
                                <tbody id="lich-tap-tbody">
                                    <tr><td colspan="6" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu l·ªãch ƒë·∫∑t...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card">
                <h3>üìä T·ªïng Quan Nhanh</h3>
                <div class="stats-box-summary">
                    <div class="stat-box">
                        <h3 class="blue" id="total-classes">0</h3>
                        <p>T·ªïng l·ªõp</p>
                    </div>
                    <div class="stat-box">
                        <h3 class="green" id="upcoming-bookings">0</h3>
                        <p>ƒê·∫∑t l·ªãch S·∫Øp t·ªõi</p>
                    </div>
                    <div class="stat-box">
                        <h3 class="orange" id="total-bookings">0</h3>
                        <p>T·ªïng s·ªë L·ªãch</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>‚ö° T√°c v·ª• nhanh</h3>
                <button class="action-btn" id="export-btn">üìä Xu·∫•t b√°o c√°o ƒëƒÉng k√Ω</button>
                <button class="action-btn" id="trainer-schedule-btn">üë©‚Äçüè´ Xem l·ªãch hu·∫•n luy·ªán vi√™n</button>
                <button class="action-btn" id="notification-btn">üîî Th√¥ng b√°o nh·∫Øc l·ªãch</button>
            </div>
        </div>
    </div>

    <script>
    // URL c∆° s·ªü c·ªßa API backend
    const API_BASE_URL = "http://localhost:5000/api"; 

    // ======================================
    // üö® BI·∫æN TO√ÄN C·ª§C CHO CH·ª®C NƒÇNG NH·∫ÆC L·ªäCH
    // ======================================
    let danhSachLich = []; 
    let reminderInterval; 

    // L·∫•y c√°c ph·∫ßn t·ª≠ HTML c·∫ßn thi·∫øt
    const modal = document.getElementById('modal-dat-lich');
    const btnDongModal = document.querySelector('.close-btn');
    const btnRefresh = document.getElementById('btn-refresh');
    const formDatLich = document.getElementById('form-dat-lich');

    const lopTapList = document.getElementById('lop-tap-list');
    const lichTapTbody = document.getElementById('lich-tap-tbody');

    const tenLopDatLich = document.getElementById('ten-lop-dat-lich');
    const hlvLopDatLich = document.getElementById('hlv-lop-dat-lich');
    const gioLopDatLich = document.getElementById('gio-lop-dat-lich');
    const idLopDat = document.getElementById('id-lop-dat');
    const ngayHocInput = document.getElementById('ngay-hoc');

    const totalClasses = document.getElementById('total-classes');
    const upcomingBookings = document.getElementById('upcoming-bookings');
    const totalBookings = document.getElementById('total-bookings');

    const exportBtn = document.getElementById('export-btn');
    const trainerScheduleBtn = document.getElementById('trainer-schedule-btn');
    const notificationBtn = document.getElementById('notification-btn'); 

    const modalThemLop = document.getElementById('modal-them-lop');
    const btnMoModalThemLop = document.getElementById('btn-mo-modal-them-lop');
    const btnDongModalThemLop = document.querySelector('.close-btn-lop');
    const formThemLop = document.getElementById('form-them-lop');
    
    // Bi·∫øn cho Bulk Delete
    const btnXoaDaChon = document.getElementById('btn-xoa-muc-da-chon');
    const btnXoaToanBoLich = document.getElementById('btn-xoa-toan-bo-lich');


    // ======================================
    // 1. T·∫¢I V√Ä HI·ªÇN TH·ªä DANH S√ÅCH L·ªöP T·∫¨P
    // ======================================
    async function fetchLopTap() {
        lopTapList.innerHTML = '<p class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu l·ªõp t·∫≠p...</p>';
        try {
            const response = await fetch(`${API_BASE_URL}/lop-tap`);
            const data = await response.json();

            if (!data || data.length === 0) {
                lopTapList.innerHTML = '<p class="loading-text">Kh√¥ng t√¨m th·∫•y l·ªõp t·∫≠p n√†o.</p>';
                return;
            }

            totalClasses.textContent = data.length;
            let totalUpcoming = data.reduce((sum, lop) => sum + (lop.so_luong_dang_ky || 0), 0);
            upcomingBookings.textContent = totalUpcoming;

            lopTapList.innerHTML = data.map(lop => `
                <div class="lop-item">
                    <h4>${lop.ten_lop} (${lop.lich_tap})</h4>
                    <p>HLV: ${lop.ten_hlv || 'Ch∆∞a ph√¢n c√¥ng'} | Gi·ªù: ${lop.gio_bat_dau.slice(0, 5)} - ${lop.gio_ket_thuc.slice(0, 5)}</p>
                    <p class="lop-info">ƒê√£ ƒêƒÉng k√Ω: <b>${lop.so_luong_dang_ky || 0}</b> / ${lop.so_luong_toi_da}</p>
                    <div class="lop-actions">
                        <button class="btn-xoa-lop" 
                                data-id="${lop.id_lop}" 
                                data-ten="${lop.ten_lop}">
                            üóëÔ∏è X√≥a
                        </button>
                        <button class="btn-dat-lich" 
                                data-id="${lop.id_lop}" 
                                data-ten="${lop.ten_lop}"
                                data-hlv="${lop.ten_hlv || 'N/A'}"
                                data-gio="${lop.gio_bat_dau.slice(0, 5)} - ${lop.gio_ket_thuc.slice(0, 5)}">
                            ƒêƒÉng k√Ω ngay
                        </button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.btn-dat-lich').forEach(button => {
                button.addEventListener('click', openDatLichModal);
            });
            
            document.querySelectorAll('.btn-xoa-lop').forEach(button => {
                button.addEventListener('click', deleteLopTap);
            });

        } catch (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch l·ªõp:", error);
            lopTapList.innerHTML = '<p class="warning-text">L·ªói khi k·∫øt n·ªëi ƒë·∫øn Server/Database. Vui l√≤ng ki·ªÉm tra Node Server.</p>';
        }
    }
    
    // ======================================
    // 2. T·∫¢I V√Ä HI·ªÇN TH·ªä DANH S√ÅCH L·ªäCH ƒê·∫∂T
    // ======================================
    async function fetchDanhSachLich() {
        lichTapTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu l·ªãch ƒë·∫∑t...</td></tr>';
        try {
            // Backend API /danh-sach-lich ƒë√£ t·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i tr∆∞·ªõc khi tr·∫£ v·ªÅ data
            const response = await fetch(`${API_BASE_URL}/danh-sach-lich`);
            const data = await response.json();

            if (!data || data.length === 0) {
                lichTapTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ch∆∞a c√≥ l·ªãch ƒë·∫∑t n√†o.</td></tr>';
                totalBookings.textContent = 0;
                danhSachLich = []; 
                return;
            }

            danhSachLich = data; 
            
            totalBookings.textContent = data.length;

            lichTapTbody.innerHTML = data.map(lich => {
                let statusClass;
                switch (lich.trang_thai) {
                    case 'ƒê√£ ƒë·∫∑t': statusClass = 'status-dat'; break;
                    case 'ƒê√£ h·ªçc': statusClass = 'status-hoc'; break;
                    case 'ƒê√£ h·ªßy': statusClass = 'status-huy'; break;
                    default: statusClass = 'status-dat';
                }

                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="lich-checkbox" data-id="${lich.id_lich}">
                        </td>
                        <td>${lich.ten_hoc_vien}</td>
                        <td>${lich.ten_lop}</td>
                        <td>${lich.ngay_hoc}</td>
                        <td>${lich.gio_bat_dau}</td>
                        <td><span class="${statusClass}">${lich.trang_thai}</span></td>
                    </tr>
                `;
            }).join('');
            
            attachCheckboxListeners();

        } catch (error) {
            console.error("L·ªói khi t·∫£i danh s√°ch l·ªãch:", error);
            lichTapTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><span class="warning-text">L·ªói khi k·∫øt n·ªëi ƒë·∫øn Server/Database.</span></td></tr>';
        }
    }


    // ======================================
    // 8. X·ª¨ L√ù X√ìA L·ªöP T·∫¨P
    // ======================================
    async function deleteLopTap(event) {
        const button = event.currentTarget;
        const id_lop = button.getAttribute('data-id');
        const ten_lop = button.getAttribute('data-ten');

        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp "${ten_lop}" (ID: ${id_lop}) kh√¥ng?`)) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/lop-tap/${id_lop}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                await fetchLopTap();
                await fetchDanhSachLich();
            } else {
                alert(`L·ªói X√≥a L·ªõp: ${result.message || "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh."}`);
                console.error("L·ªói x√≥a l·ªõp:", result);
            }
        } catch (error) {
            console.error("L·ªói k·∫øt n·ªëi khi x√≥a l·ªõp:", error);
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng ki·ªÉm tra Server Node.js.");
        }
    }


    // ======================================
    // 9. X·ª¨ L√ù X√ìA DANH S√ÅCH L·ªäCH ƒê·∫∂T (X√≥a To√†n B·ªô)
    // ======================================
    async function deleteAllBookings() {
        if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO! B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò danh s√°ch l·ªãch ƒë√£ ƒë·∫∑t kh√¥ng? Thao t√°c n√†y KH√îNG th·ªÉ ho√†n t√°c!")) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/danh-sach-lich`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                await fetchLopTap(); 
                await fetchDanhSachLich();
            } else {
                alert(`L·ªói X√≥a L·ªãch ƒê·∫∑t: ${result.message || "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh."}`);
                console.error("L·ªói x√≥a to√†n b·ªô l·ªãch ƒë·∫∑t:", result);
            }
        } catch (error) {
            console.error("L·ªói k·∫øt n·ªëi khi x√≥a l·ªãch ƒë·∫∑t:", error);
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng ki·ªÉm tra Server Node.js.");
        }
    }

    // ======================================
    // 10. X·ª¨ L√ù X√ìA M·ª§C ƒê√É CH·ªåN (Bulk Delete)
    // ======================================
    async function deleteSelectedBookings() {
        const selectedCheckboxes = document.querySelectorAll('.lich-checkbox:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-id'));

        if (selectedIds.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt l·ªãch ƒë·ªÉ x√≥a.");
            return;
        }

        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ${selectedIds.length} l·ªãch ƒë√£ ch·ªçn kh√¥ng?`)) {
            return;
        }

        let successCount = 0;
        let errorCount = 0;

        // Duy·ªát qua t·ª´ng ID v√† g·ªçi API DELETE cho t·ª´ng l·ªãch ƒë·∫∑t
        for (const id of selectedIds) {
            try {
                const response = await fetch(`${API_BASE_URL}/dat-lich/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    successCount++;
                } else {
                    errorCount++;
                }
            } catch (error) {
                console.error(`L·ªói khi x√≥a l·ªãch ID ${id}:`, error);
                errorCount++;
            }
        }

        if (errorCount === 0) {
            alert(`üéâ ƒê√£ x√≥a th√†nh c√¥ng ${successCount} l·ªãch!`);
        } else {
            alert(`‚ö†Ô∏è X√≥a ho√†n t·∫•t. Th√†nh c√¥ng: ${successCount}. Th·∫•t b·∫°i: ${errorCount}.`);
        }

        // T·∫£i l·∫°i d·ªØ li·ªáu sau khi x√≥a
        await fetchLopTap(); 
        await fetchDanhSachLich();
    }

    // ======================================
    // 11. C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI N√öT V√Ä G√ÅN S·ª∞ KI·ªÜN CHECKBOX
    // ======================================
    
    function updateDeleteButtonState() {
        const totalChecked = document.querySelectorAll('.lich-checkbox:checked').length;
        btnXoaDaChon.disabled = totalChecked === 0;
        if (totalChecked > 0) {
            btnXoaDaChon.textContent = `üóëÔ∏è X√≥a ${totalChecked} M·ª•c ƒê√£ Ch·ªçn`;
        } else {
            btnXoaDaChon.textContent = `üóëÔ∏è X√≥a M·ª•c ƒê√£ Ch·ªçn`;
        }
    }

    function attachCheckboxListeners() {
        const checkboxes = document.querySelectorAll('.lich-checkbox');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateDeleteButtonState);
        });
        updateDeleteButtonState();
    }


    // ======================================
    // 3. X·ª¨ L√ù MODAL (v√† c√°c h√†m ph·ª• tr·ª£)
    // ======================================
    function openDatLichModal(event) {
        const button = event.currentTarget;
        const id = button.getAttribute('data-id');
        const ten = button.getAttribute('data-ten');
        const hlv = button.getAttribute('data-hlv');
        const gio = button.getAttribute('data-gio');

        tenLopDatLich.textContent = ten;
        hlvLopDatLich.textContent = hlv;
        gioLopDatLich.textContent = gio;
        idLopDat.value = id;

        const today = new Date().toISOString().split('T')[0];
        ngayHocInput.value = today;
        ngayHocInput.setAttribute('min', today); 

        modal.style.display = "block";
    }

    btnDongModal.onclick = function() { modal.style.display = "none"; }
    btnMoModalThemLop.onclick = function() { modalThemLop.style.display = "block"; }
    btnDongModalThemLop.onclick = function() { modalThemLop.style.display = "none"; }

    window.onclick = function(event) {
        if (event.target == modalThemLop) { modalThemLop.style.display = "none"; }
        if (event.target == modal) { modal.style.display = "none"; }
    }


    // ======================================
    // 4. G·ª¨I Y√äU C·∫¶U ƒê·∫∂T L·ªäCH (FORM SUBMIT)
    // ======================================
    formDatLich.addEventListener('submit', async function(e) {
        e.preventDefault(); 

        const bookingData = {
            id_hoc_vien: parseInt(document.getElementById('id-hoc-vien').value),
            id_lop: parseInt(idLopDat.value),
            ngay_hoc: ngayHocInput.value
        };

        try {
            const response = await fetch(`${API_BASE_URL}/dat-lich`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                modal.style.display = "none";
                await fetchLopTap(); 
                await fetchDanhSachLich();
            } else {
                alert(`L·ªói ƒê·∫∑t l·ªãch: ${result.message || "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh."}`);
            }
        } catch (error) {
            console.error("L·ªói khi g·ª≠i y√™u c·∫ßu ƒë·∫∑t l·ªãch:", error);
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng ki·ªÉm tra Server Node.js.");
        }
    });

    // ======================================
    // 5. X·ª¨ L√ù FORM TH√äM L·ªöP M·ªöI
    // ======================================
    formThemLop.addEventListener('submit', async function(e) {
        e.preventDefault(); 

        const lopData = {
            ten_lop: document.getElementById('ten-lop').value,
            lich_tap: document.getElementById('lich-tap').value,
            so_luong_toi_da: parseInt(document.getElementById('so-luong-toi-da').value),
            gio_bat_dau: document.getElementById('gio-bat-dau').value,
            gio_ket_thuc: document.getElementById('gio-ket-thuc').value,
            id_hlv: document.getElementById('id-hlv-moi').value ? parseInt(document.getElementById('id-hlv-moi').value) : undefined
        };

        try {
            const response = await fetch(`${API_BASE_URL}/lop-tap/them-moi`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lopData)
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                modalThemLop.style.display = "none";
                formThemLop.reset();
                await fetchLopTap(); 
            } else {
                alert(`L·ªói th√™m l·ªõp: ${result.message || "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh."}`);
            }
        } catch (error) {
            console.error("L·ªói khi g·ª≠i y√™u c·∫ßu th√™m l·ªõp:", error);
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng ki·ªÉm tra Server Node.js.");
        }
    });


    // ======================================
    // 6. X·ª¨ L√ù T√ÅC V·ª§ NHANH (FAST ACTIONS)
    // ======================================

    exportBtn.onclick = () => {
        alert("ƒêang y√™u c·∫ßu server t·∫°o v√† t·∫£i file Excel...");
        window.location.href = `${API_BASE_URL}/bao-cao/tong-hop`;
        console.log("Y√™u c·∫ßu t·∫£i file Excel ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn:", `${API_BASE_URL}/bao-cao/tong-hop`);
    };

  // 6.2. X·ª≠ l√Ω n√∫t Xem l·ªãch hu·∫•n luy·ªán vi√™n (T·∫£i file Excel)
trainerScheduleBtn.onclick = () => {
    const HLV_ID_TEST = 1; // ID HLV m·∫´u ƒë·ªÉ test. C·∫ßn thay ƒë·ªïi ID n√†y theo nhu c·∫ßu.
    alert(`ƒêang y√™u c·∫ßu server t·∫£i l·ªãch HLV ID ${HLV_ID_TEST} d∆∞·ªõi d·∫°ng file Excel...`);
    
    // K√≠ch ho·∫°t t·∫£i file t·ª´ API
    window.location.href = `${API_BASE_URL}/hlv/${HLV_ID_TEST}/lich`;
    
    console.log("Y√™u c·∫ßu t·∫£i l·ªãch HLV ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn:", `${API_BASE_URL}/hlv/${HLV_ID_TEST}/lich`);
};
    function checkReminders() {
        const now = new Date();
        // ƒê·ªãnh d·∫°ng ng√†y t·ª´ API l√† DD/MM/YYYY
        const todayStr = now.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }); 

        let reminderCount = 0;

        danhSachLich.forEach(lich => {
            // Ch·ªâ ki·ªÉm tra nh·∫Øc l·ªãch cho c√°c l·ªãch 'ƒê√£ ƒë·∫∑t' trong ng√†y h√¥m nay
            if (lich.trang_thai === 'ƒê√£ ƒë·∫∑t' && lich.ngay_hoc === todayStr) {
                
                if (typeof lich.reminded_15m === 'undefined') {
                    lich.reminded_15m = false;
                }
                if (lich.reminded_15m) return;


                const [day, month, year] = lich.ngay_hoc.split('/');
                const [hour, minute] = lich.gio_bat_dau.split(':'); 
                // S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Date(YYYY, MM-1, DD, HH, MM)
                const scheduledTime = new Date(year, month - 1, day, hour, minute, 0); 

                const diffMs = scheduledTime.getTime() - now.getTime();
                const diffMinutes = Math.round(diffMs / 60000); 

                if (diffMinutes > 14 && diffMinutes <= 15) { 
                    
                    lich.reminded_15m = true; 
                    reminderCount++;

                    alert(`üîî NH·∫ÆC L·ªäCH!\nL·ªõp: ${lich.ten_lop} (HLV: ${lich.ten_hlv || 'N/A'})\nH·ªçc vi√™n: ${lich.ten_hoc_vien}\nC√≤n kho·∫£ng 15 ph√∫t n·ªØa l√† b·∫Øt ƒë·∫ßu l√∫c ${lich.gio_bat_dau}!`);
                    console.warn(`[REMINDER TRIGGERED - 15M BEFORE] L·ªõp: ${lich.ten_lop} | Gi·ªù: ${lich.gio_bat_dau}`);
                }
            }
        });

        if (reminderCount === 0) {
            console.log(`Ki·ªÉm tra nh·∫Øc l·ªãch ho√†n t·∫•t (${now.toLocaleTimeString('vi-VN')}).`);
        }
    }

    function startReminderService() {
        if (reminderInterval) {
            clearInterval(reminderInterval);
            console.log("D·ªãch v·ª• nh·∫Øc l·ªãch c≈© ƒë√£ ƒë∆∞·ª£c d·ª´ng.");
        }
        
        fetchDanhSachLich().then(() => {
            if (danhSachLich.length === 0) {
                alert("Kh√¥ng c√≥ l·ªãch ƒë·∫∑t n√†o ƒë·ªÉ thi·∫øt l·∫≠p nh·∫Øc nh·ªü.");
                return;
            }

            alert("‚úÖ D·ªãch v·ª• nh·∫Øc l·ªãch th·ªùi gian th·ª±c ƒë√£ ƒë∆∞·ª£c B·∫¨T! (S·∫Ω ki·ªÉm tra m·ªói 15 gi√¢y).");
            console.log("D·ªãch v·ª• nh·∫Øc l·ªãch B·∫¨T. ƒêang ki·ªÉm tra...");

            checkReminders(); 
            reminderInterval = setInterval(checkReminders, 15000); 
        });
    }

    notificationBtn.onclick = startReminderService;

    // ======================================
    // 7. KH·ªûI CH·∫†Y CH∆Ø∆†NG TR√åNH V√Ä G√ÅN S·ª∞ KI·ªÜN CH√çNH
    // ======================================
    
    btnXoaToanBoLich.addEventListener('click', deleteAllBookings);
    btnXoaDaChon.addEventListener('click', deleteSelectedBookings);

    async function initializeApp() {
        await fetchLopTap();
        await fetchDanhSachLich();
    }

    btnRefresh.addEventListener('click', initializeApp);
    document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>